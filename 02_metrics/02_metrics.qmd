---
title: "02_metrics"
author: "matheusmoroti"
format: html
editor: visual
---

### 0.0. Libraries

```{r}
library(visdat) # missing data check
library(tidyverse) # data science handling
library(letsR) # spatial data package
library(rgdal) # spatial data package
library(sf) # spatial data package
library(phytools) # phylogenetic data
library(BAMMtools) # trait evolution rate
library(coda) # check mcmc run convergence
library(rgdal) #spatial data
library(letsR) #spatial data 
```

### 0.1. Functions

```{r}
lets.summarizer2 <- function (x, pos, xy = TRUE, fun = mean) 
{
  var <- x[, pos, drop = FALSE]
  sp <- x[, -pos, drop = FALSE]
  if (xy) {
    sp <- sp[, -(1:2), drop = FALSE]
  }
  Species <- colnames(sp)
  n <- length(Species)
  lpos <- length(pos)
  resum <- matrix(NA, nrow = n, ncol = lpos)
  colnames(resum) <- colnames(var)
  for (i in 1:n) {
    vari <- var[(sp[, i] == 1), , drop = FALSE]
    is_all_na <- apply(vari, 2, function(x) {
      all(is.na(x))
    })
    if (nrow(vari) == 0 | all(is_all_na)) {
      resum[i, ] <- rep(NA, lpos)
    }
    else {
      if (any(is_all_na)) {
        resum[i, is_all_na] <- NA
      }
      resum[i, !is_all_na] <- apply(vari[, !is_all_na, 
                                         drop = FALSE], 2, fun, na.rm = TRUE)
    }
  }
  resul <- as.data.frame(cbind(Species, resum))
  return(resul)
}
```

### 0.2. Load data

##### 0.2.1. Trait data

```{r}
###--- Amphibia
anura_traits_full <- read.table("full_data/amphibia_traits_fully.txt")
anura_traits_harm <- read.table("harmonized_data/amphibia_traits_harm.txt")
###--- Squamata
squamata_traits_full <- read.table("full_data/squamata_traits_fully.txt")

###--- Birds
birds_traits_full <- read.table("full_data/birds_traits_fully.txt")

###--- Mammals
mammals_traits_full <- read.table("full_data/mammals_traits_fully.txt")
mammals_traits_harm <- read.table("harmonized_data/mammals_traits_harm.txt")
```

##### 0.2.2. Phylogenetic data

```{r}
# note: ler as árvores pós script fix_error (min branch lenght negative and zero values)
###--- Amphibia
anura_phy_full <- read.tree("full_data/amphibia_fully.new_noNeg_minBL.newick")
is.ultrametric(anura_phy_full) # FALSE

anura_phy_harm <- read.tree("harmonized_data/amphibia_harm.new_noNeg_minBL.newick")
is.ultrametric(anura_phy_harm) # FALSE

###--- Squamata
squamata_phy_full <- read.tree("full_data/squamata_fully.new_noNeg_minBL.newick")
is.ultrametric(squamata_phy_full) # FALSE

###--- Birds
birds_phy_full <- read.tree("full_data/birds_fully.new_noNeg_minBL.newick")
is.ultrametric(birds_phy_full) # FALSE

###--- Mammals
mammals_phy_full <- read.tree("full_data/mammals_fully.new_noNeg.newick")
is.ultrametric(mammals_phy_full) # TRUE

mammals_phy_harm <- read.tree("harmonized_data/mammals_harm.new_noNeg.newick")
is.ultrametric(mammals_phy_harm) # TRUE
```

##### 0.2.3. Climate data

Past data by Barreto et al., 2003 - PALEO-PGEM-Series: A spatial time series of the global climate over the last 5 million years (Plio-Pleistocene)
```{r}
# PALEO-PGEM-Series - Barreto et al., 2023
bio01_past <- read.table("climate_data/bio1_mean.txt", header = TRUE)
bio04_past <- read.table("climate_data/bio4_mean.txt", header = TRUE)
bio07_past <- read.table("climate_data/bio7_mean.txt", header = TRUE)
bio11_past <- read.table("climate_data/bio11_mean.txt", header = TRUE)
bio15_past <- read.table("climate_data/bio15_mean.txt", header = TRUE)
bio17_past <- read.table("climate_data/bio17_mean.txt", header = TRUE)
View(bio01_past)
```

Convert dataframe into raster file
```{r}
# convert to raster file
bio01_past_r <- raster(extent(min(bio01_past$Long), max(bio01_past$Long), min(bio01_past$Lat), max(bio01_past$Lat)),resolution = 1, crs = "+proj=longlat +datum=WGS84")
bio01_past_r <- rasterize(bio01_past[,1:2], bio01_past_r, bio01_past[,3])

bio04_past_r <- raster(extent(min(bio04_past$Long), max(bio04_past$Long), min(bio04_past$Lat), max(bio04_past$Lat)),resolution = 1, crs = "+proj=longlat +datum=WGS84")
bio04_past_r <- rasterize(bio04_past[,1:2], bio04_past_r, bio04_past[,3])

bio07_past_r <- raster(extent(min(bio07_past$Long), max(bio07_past$Long), min(bio07_past$Lat), max(bio07_past$Lat)),resolution = 1, crs = "+proj=longlat +datum=WGS84")
bio07_past_r <- rasterize(bio07_past[,1:2], bio07_past_r, bio07_past[,3])

bio11_past_r <- raster(extent(min(bio11_past$Long), max(bio11_past$Long), min(bio11_past$Lat), max(bio11_past$Lat)),resolution = 1, crs = "+proj=longlat +datum=WGS84")
bio11_past_r <- rasterize(bio11_past[,1:2], bio11_past_r, bio11_past[,3])

bio15_past_r <- raster(extent(min(bio15_past$Long), max(bio15_past$Long), min(bio15_past$Lat), max(bio15_past$Lat)),resolution = 1, crs = "+proj=longlat +datum=WGS84")
bio15_past_r <- rasterize(bio15_past[,1:2], bio15_past_r, bio15_past[,3])

bio17_past_r <- raster(extent(min(bio17_past$Long), max(bio17_past$Long), min(bio17_past$Lat), max(bio17_past$Lat)),resolution = 1, crs = "+proj=longlat +datum=WGS84")
bio17_past_r <- rasterize(bio17_past[,1:2], bio17_past_r, bio17_past[,3])
```

Load present data
```{r}
# Climate data from CHELSA
Bio01 <- raster("climate_data/CHELSA_bio1_1981-2010_V.2.1.tif") # mean annual air temperature
Bio04 <- raster("climate_data/CHELSA_bio4_1981-2010_V.2.1.tif") #Temperature Seasonality
Bio07 <- raster("climate_data/CHELSA_bio7_1981-2010_V.2.1.tif") #Temperature Annual Range
Bio11 <- raster("climate_data/CHELSA_bio11_1981-2010_V.2.1.tif") #Mean Temperature of Coldest Quarter
Bio15 <- raster("climate_data/CHELSA_bio15_1981-2010_V.2.1.tif") #Precipitation Seasonality
Bio17 <- raster("climate_data/CHELSA_bio17_1981-2010_V.2.1.tif") #Precipitation of Driest Quarter
```

##### 0.2.4. Shapefile data

```{r}
#--- Amphibia
anura_shape <- readOGR("shapefiles/ANURA_SA_clip.shp")
###--- Squamata
squamata_shape <- readOGR("shapefiles/modeled_reptiles.shp")
###--- Birds
birds_shape <- shapefile("shapefiles/birds.shp")
View(birds_shape)
###--- Mammals
mammals_shape <- readOGR("shapefiles/data_0.shp")
```

### 1.0. Data processing for BAMM analysis

#### 1.1. Complete dataset
##### 1.1.1. Frogs
```{r}
# arvores precisam ser ultrametricas, binárias (sem politomias) e sem valor de ramo = 0
amphibia_phy_ultra <- force.ultrametric(anura_phy_full)

write.tree(amphibia_phy_ultra, "BAMM/amphibia/amphibia_fully_bamm.new")

# preparing data for setBAMMpriors
svl_amphibia <- as.numeric(anura_traits_full$V2)
names(svl_amphibia) <- anura_traits_full$V1

# setBAMMprior para achar os valores de priors
#setBAMMpriors(phy = anura_phy_full, traits = svl_amphibia)
priors <- BAMMtools::setBAMMpriors(phy = anura_phy_full, total.taxa = nrow(anura_traits_full), traits = svl_amphibia, outfile = NULL) 

generateControlFile(file = 'BAMM/amphibia/controlfile_amphibia.txt', type = 'trait', params = list(
    treefile = 'amphibia_fully_bamm.new',
    traitfile='amphibia_traits_fully.txt',
    numberOfGenerations = '12000000',
    overwrite = '1',
    betaShiftPrior = as.numeric(priors['betaShiftPrior']),
    betaInitPrior = as.numeric(priors['betaInitPrior']),
    useObservedMinMaxAsTraitPriors = '1',
    expectedNumberOfShifts = as.numeric(priors['expectedNumberOfShifts'])))
```

Check MCMC run convergence
```{r}
mcmcout <- read.table("BAMM/amphibia/mcmc_out.txt",sep=',', header=T)
plot(mcmcout$logLik ~ mcmcout$generation)

burnstart <- floor(0.25 * nrow(mcmcout))
postburn <- mcmcout[burnstart:nrow(mcmcout), ]
effectiveSize(postburn$N_shifts) # 134.17 - must be at least 200 for big data
effectiveSize(postburn$logLik)
```

Using BAMM tools to retrieve trait evolution rate per tip
```{r}
# Tue Apr 18 19:07:03 2023 ------------------------------
# BAMMTools
#events.amphibia <- read.table("BAMM/amphibia/event_data.txt", sep=",", header=T)
amphibia_phy_rooted <- ape::multi2di(amphibia_phy_ultra)

edata_amphibia <- getEventData(amphibia_phy_rooted, "BAMM/amphibia/event_data.txt", burnin=0.25, type='trait')
getwd()
#plotRateThroughTime(edata_amphibia, ratetype="auto", smooth=TRUE)
mean_anura <- getTipRates(edata_amphibia, statistic = 'mean')$beta.avg
write.table(mean_anura, "amphibia_rates_fully.txt",quote = FALSE, col.names = FALSE,row.names = TRUE)
#plot.bammdata(edata, lwd=1, method="polar", pal="temperature")
```

##### 1.1.2. Squamatas
```{r}
# arvores precisam ser ultrametricas, binárias (sem politomias) e sem valor de ramo = 0
squamata_phy_ultra <- force.ultrametric(squamata_phy_full)
write.tree(squamata_phy_ultra, "BAMM/squamata/squamata_fully_bamm.new")

# preparing traits
# Squamata
svl_squamata <- as.numeric(squamata_traits_full$V2)
names(svl_squamata) <- squamata_traits_full$V1

# setBAMMprior para achar os valores de priors
priors <- setBAMMpriors(phy = squamata_phy_ultra, traits = svl_squamata, outfile = NULL)

getwd()
generateControlFile(file = 'BAMM/squamata/controlfile_squamata.txt', type = 'trait', params = list(
    treefile = 'squamata_fully_bamm.new',
    traitfile='squamata_traits_fully.txt',
    numberOfGenerations = '12000000',
    overwrite = '1',
    betaShiftPrior = as.numeric(priors['betaShiftPrior']),
    betaInitPrior = as.numeric(priors['betaInitPrior']),
    useObservedMinMaxAsTraitPriors = '1',
    expectedNumberOfShifts = as.numeric(priors['expectedNumberOfShifts'])))
```

Check MCMC run convergence
```{r}
mcmcout <- read.table("BAMM/squamata/squamata/mcmc_out.txt",sep=',', header=T)
tail(mcmcout)
plot(mcmcout$logLik ~ mcmcout$generation)

burnstart <- floor(0.25 * nrow(mcmcout))
postburn <- mcmcout[burnstart:nrow(mcmcout), ]

effectiveSize(postburn$N_shifts)
effectiveSize(postburn$logLik)
# Also, remember that comments in R are lines that start with
#     a pound sign. We'll occasionally use them here.
#     R will not execute these lines - they are only for reference!
```

Exploring BAMMTools
```{r}
# Tue Apr 18 19:07:03 2023 ------------------------------
# BAMMTools
events_squamata <- read.table("BAMM/squamata/squamata/event_data.txt", sep=",", header=T)
squamata_phy_rooted <- ape::multi2di(squamata_phy_ultra)

# plot rate through time
edata_squamata <- getEventData(squamata_phy_rooted, events_squamata, burnin=0.25, type='trait')

plotRateThroughTime(edata_squamata, ratetype="auto", smooth=TRUE)

# trait evolution rate per species
mean_squamata <- getTipRates(edata_squamata, returnNetDiv = FALSE,
                       statistic = 'mean')$beta.avg
# plot
#plot.bammdata(edata_squamata, lwd=1, method="polar", pal="temperature")
```

##### 1.1.3. Birds
```{r}
# arvores precisam ser ultrametricas, binárias (sem politomias) e sem valor de ramo = 0
birds_phy_ultra <- force.ultrametric(birds_phy_full)
write.tree(birds_phy_ultra, "BAMM/birds/birds_fully_bamm.new")

# preparing traits
# Squamata
mass_birds <- as.numeric(birds_traits_full$Mass)
names(mass_birds) <- birds_traits_full$Species3

# setBAMMprior para achar os valores de priors
priors <- setBAMMpriors(phy = birds_phy_ultra, traits = mass_birds, outfile = NULL)

generateControlFile(file = 'BAMM/birds/controlfile_birds.txt', type = 'trait', params = list(
    treefile = 'birds_fully_bamm.new',
    traitfile='birds_traits_fully.txt',
    numberOfGenerations = '12000000',
    overwrite = '1',
    betaShiftPrior = as.numeric(priors['betaShiftPrior']),
    betaInitPrior = as.numeric(priors['betaInitPrior']),
    useObservedMinMaxAsTraitPriors = '1',
    expectedNumberOfShifts = as.numeric(priors['expectedNumberOfShifts'])))
```

Check MCMC run convergence
```{r}
mcmcout <- read.table("BAMM/birds/mcmc_out.txt",sep=',', header=T)
tail(mcmcout)
plot(mcmcout$logLik ~ mcmcout$generation)

burnstart <- floor(0.1 * nrow(mcmcout))
postburn <- mcmcout[burnstart:nrow(mcmcout), ]

effectiveSize(postburn$N_shifts)
effectiveSize(postburn$logLik)
# Also, remember that comments in R are lines that start with
#     a pound sign. We'll occasionally use them here.
#     R will not execute these lines - they are only for reference!
```

```{r} 
# Tue Apr 18 19:07:03 2023 ------------------------------
# BAMMTools
events.birds <- read.table("BAMM/birds/event_data.txt", sep=',', header=T)
birds_phy_rooted <- ape::multi2di(birds_phy_ultra)
edata_birds <- getEventData(birds_phy_rooted, events.birds, burnin=0.01, type='trait')

#plotRateThroughTime(edata_birds, ratetype="auto", smooth=TRUE)

mean_birds <- getTipRates(edata_birds, returnNetDiv = FALSE,
                       statistic = 'mean')$beta.avg

#plot.bammdata(edata_birds, lwd=1, method="polar", pal="temperature")
```

##### 1.1.4. Mammals
```{r}
# arvores precisam ser ultrametricas, binárias (sem politomias) e sem valor de ramo = 0
mammals_phy_ultra <- force.ultrametric(mammals_phy_full)
write.tree(mammals_phy_ultra, "BAMM/mammals/mammals_fully_bamm.new")

# preparing traits
# Squamata
mass_mammals <- as.numeric(mammals_traits_full$V2)
names(mass_mammals) <- mammals_traits_full$V1

# setBAMMprior para achar os valores de priors
priors <- setBAMMpriors(phy = mammals_phy_ultra, traits = mass_mammals, outfile = NULL)

generateControlFile(file = 'BAMM/mammals/controlfile_mammals.txt', type = 'trait', params = list(
    treefile = 'mammals_fully_bamm.new',
    traitfile='mammals_traits_fully.txt',
    numberOfGenerations = '30000000',
    overwrite = '1',
    betaShiftPrior = as.numeric(priors['betaShiftPrior']),
    betaInitPrior = as.numeric(priors['betaInitPrior']),
    useObservedMinMaxAsTraitPriors = '1',
    expectedNumberOfShifts = as.numeric(priors['expectedNumberOfShifts'])))
```

Check MCMC run convergence
```{r}
mcmcout <- read.table("BAMM/birds/mcmc_out.txt",sep=',', header=T)
tail(mcmcout)
plot(mcmcout$logLik ~ mcmcout$generation)

burnstart <- floor(0.1 * nrow(mcmcout))
postburn <- mcmcout[burnstart:nrow(mcmcout), ]

effectiveSize(postburn$N_shifts)
effectiveSize(postburn$logLik)
# Also, remember that comments in R are lines that start with
#     a pound sign. We'll occasionally use them here.
#     R will not execute these lines - they are only for reference!
```

BAMMTools exploring
```{r}
# Tue Apr 18 19:07:03 2023 ------------------------------
# BAMMTools
events.mammals <- read.table("BAMM/mammals/event_data.txt", sep=',', header=T)
mammals_phy_rooted <- ape::multi2di(mammals_phy_ultra)
edata_mammals <- getEventData(mammals_phy_rooted, events.mammals, burnin=0.01, type='trait')
plotRateThroughTime(edata_mammals, ratetype="auto", smooth=TRUE)

mean_mammals <- getTipRates(edata_mammals, returnNetDiv = FALSE,
                       statistic = 'mean')$beta.avg

plot.bammdata(edata_mammals, lwd=1, method="polar", pal="temperature")
```


#### 1.2 Harmonized dataset

##### 1.2.1. Frogs
```{r}
# preparing data for setBAMMpriors
svl_amphibia_harm <- as.numeric(anura_traits_harm$V2)
names(svl_amphibia_harm) <- anura_traits_harm$V1

# setBAMMprior para achar os valores de priors
setBAMMpriors(phy = anura_phy_harm, traits = svl_amphibia_harm)

# arvores precisam ser ultrametricas, binárias (sem politomias) e sem valor de ramo = 0
amphibia_phy_ultra_harm <- force.ultrametric(anura_phy_harm)
write.tree(amphibia_phy_ultra_harm, "BAMM/amphibia_harm/amphibia_harm_bamm.new")

getwd()
generateControlFile(file = 'BAMM/amphibia_harm/controlfile_amphibia.txt', type = 'trait', params = list(
    treefile = 'amphibia_harm_bamm.new',
    traitfile='amphibia_traits_harm.txt',
    numberOfGenerations = '10000',
    overwrite = '1',
    betaInitPrior = '407.026502174263',
    betaShiftPrior = '0.0036834541498432',
    useObservedMinMaxAsTraitPriors = '1',
    expectedNumberOfShifts = '1.0'))
```

Check MCMC run convergence
```{r}
mcmcout <- read.table("BAMM/amphibia_harm/mcmc_out.txt",sep=',', header=T)
head(mcmcout)
plot(mcmcout$logLik ~ mcmcout$generation)

burnstart <- floor(0.1 * nrow(mcmcout))
postburn <- mcmcout[burnstart:nrow(mcmcout), ]

effectiveSize(postburn$N_shifts)
effectiveSize(postburn$logLik)
```

```{r}
# Tue Apr 18 19:07:03 2023 ------------------------------
# BAMMTools
events.amphibia <- read.table("BAMM/amphibia_harm/event_data.txt", sep=',', header=T)
amphibia_phy_rooted <- ape::multi2di(anura_phy_full)

edata <- getEventData(amphibia_phy_rooted, events.amphibia, burnin=0.01, type='trait')
plotRateThroughTime(edata, ratetype="auto", smooth=TRUE)

mean_anura <- getTipRates(edata, returnNetDiv = FALSE,
                       statistic = 'mean')$beta.avg

plot.bammdata(edata, lwd=1, method="polar", pal="temperature")
```

##### 1.2.2. Mammals
```{r}
# arvores precisam ser ultrametricas, binárias (sem politomias) e sem valor de ramo = 0
mammals_phy_ultra_harm <- force.ultrametric(mammals_phy_harm)
write.tree(mammals_phy_ultra_harm, "BAMM/mammals_harm/mammals_harm_bamm.new")

# preparing traits
# Squamata
mass_mammals_harm <- as.numeric(mammals_traits_harm$V2)
names(mass_mammals_harm) <- mammals_traits_harm$V1

# setBAMMprior para achar os valores de priors
priors = setBAMMpriors(phy = mammals_phy_ultra_harm, traits = mass_mammals_harm,outfile = NULL)

generateControlFile(file = 'BAMM/mammals_harm/controlfile_mammals.txt', type = 'trait', 
                    params = list(
    treefile = 'mammals_harm_bamm.new',
    traitfile='mammals_traits_harm.txt',
    numberOfGenerations = '15000000',
    mcmcWriteFreq = '1000',
    overwrite = '1',
    useObservedMinMaxAsTraitPriors = as.numeric(priors['useObservedMinMaxAsTraitPriors']),
    betaShiftPrior = as.numeric(priors['betaShiftPrior']),
    betaInitPrior = as.numeric(priors['betaInitPrior']),
    expectedNumberOfShifts = as.numeric(priors['expectedNumberOfShifts'])))

```

Check MCMC run convergence
```{r}
mcmcout <- read.table("BAMM/mammals_harm/mcmc_out.txt",sep=',', header=T)
plot(mcmcout$logLik ~ mcmcout$generation)

burnstart <- floor(0.25 * nrow(mcmcout))
postburn <- mcmcout[burnstart:nrow(mcmcout), ]

effectiveSize(postburn$N_shifts)
effectiveSize(postburn$logLik)
# Also, remember that comments in R are lines that start with
#     a pound sign. We'll occasionally use them here.
#     R will not execute these lines - they are only for reference!
```

BAMMTools exploring
```{r}
# Tue Apr 18 19:07:03 2023 ------------------------------
# BAMMTools
events.mammals <- read.table("BAMM/mammals_harm/event_data.txt", sep=',', header=T)
mammals_phy_rooted <- ape::multi2di(mammals_phy_ultra)
edata_mammals <- getEventData(mammals_phy_rooted, events.mammals, burnin=0.01, type='trait')
plotRateThroughTime(edata_mammals, ratetype="auto", smooth=TRUE)

mean_mammals <- getTipRates(edata_mammals, returnNetDiv = FALSE,
                       statistic = 'mean')$beta.avg

plot.bammdata(edata_mammals, lwd=1, method="polar", pal="temperature")
```


### 2.0. Lets add var
#### 2.1. Past climate
##### 2.1.1. Frogs
```{r}
# Creating PresenceAusence object for lets.addvar
anura_presaus <- lets.presab(anura_shape , xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(anura_presaus$Richness_Raster) <- projection(bio17_past_r)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
anura_temp_median_01 <- lets.addvar(anura_presaus, bio01_past_r, fun = median, onlyvar = FALSE)
anura_temp_median_04 <- lets.addvar(anura_presaus, bio04_past_r, fun = median, onlyvar = TRUE) 
anura_temp_median_07 <- lets.addvar(anura_presaus, bio07_past_r, fun = median, onlyvar = TRUE)
anura_temp_median_11 <- lets.addvar(anura_presaus, bio11_past_r, fun = median, onlyvar = TRUE)
anura_temp_median_15 <- lets.addvar(anura_presaus, bio15_past_r, fun = median, onlyvar = TRUE)
anura_temp_median_17 <- lets.addvar(anura_presaus, bio17_past_r, fun = median, onlyvar = TRUE)

# Grouping data set
anura_temp_median <- cbind(anura_temp_median_01, anura_temp_median_04, anura_temp_median_07, anura_temp_median_11, anura_temp_median_15, anura_temp_median_17)

# Now, we need to summarise the climate variables per specie
temp_median_anura <- lets.summarizer2(anura_temp_median,  pos = 2625:2630, fun = median) 

colnames(temp_median_anura) <- c("Species", "Bio01_past", "Bio04_past", "Bio07_past",
                                 "Bio11_past", "Bio15_past", "Bio17_past")
glimpse(temp_median_anura)
```

##### 2.1.2. Squamata
```{r}
# Creating PresenceAusence object for lets.addvar
squamata_presaus <- lets.presab(squamata_shape , xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(squamata_presaus$Richness_Raster) <- projection(bio17_past_r)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
squamata_temp_median_01 <- lets.addvar(squamata_presaus, bio01_past_r, fun = median, onlyvar = FALSE)
squamata_temp_median_04 <- lets.addvar(squamata_presaus, bio04_past_r, fun = median, onlyvar = TRUE) 
squamata_temp_median_07 <- lets.addvar(squamata_presaus, bio07_past_r, fun = median, onlyvar = TRUE)
squamata_temp_median_11 <- lets.addvar(squamata_presaus, bio11_past_r, fun = median, onlyvar = TRUE)
squamata_temp_median_15 <- lets.addvar(squamata_presaus, bio15_past_r, fun = median, onlyvar = TRUE)
squamata_temp_median_17 <- lets.addvar(squamata_presaus, bio17_past_r, fun = median, onlyvar = TRUE)

# Grouping data set
squamata_temp_median <- cbind(squamata_temp_median_01, squamata_temp_median_04, squamata_temp_median_07, squamata_temp_median_11, squamata_temp_median_15, squamata_temp_median_17)
View(squamata_temp_median)
# Now, we need to summarise the climate variables per specie
temp_median_squamata <- lets.summarizer2(squamata_temp_median,  pos = 1049:1054, fun = median) 

colnames(temp_median_squamata) <- c("Species", "Bio01_past", "Bio04_past", "Bio07_past",
                                 "Bio11_past", "Bio15_past", "Bio17_past")
glimpse(temp_median_squamata)
```

##### 2.1.3. Birds
```{r}
# Creating PresenceAusence object for lets.addvar
birds_presaus <- lets.presab(birds_shape, xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(squamata_presaus$Richness_Raster) <- projection(bio17_past_r)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
birds_temp_median_01 <- lets.addvar(birds_presaus, bio01_past_r, fun = median, onlyvar = FALSE)
birds_temp_median_04 <- lets.addvar(birds_presaus, bio04_past_r, fun = median, onlyvar = TRUE) 
birds_temp_median_07 <- lets.addvar(birds_presaus, bio07_past_r, fun = median, onlyvar = TRUE)
birds_temp_median_11 <- lets.addvar(birds_presaus, bio11_past_r, fun = median, onlyvar = TRUE)
birds_temp_median_15 <- lets.addvar(birds_presaus, bio15_past_r, fun = median, onlyvar = TRUE)
birds_temp_median_17 <- lets.addvar(birds_presaus, bio17_past_r, fun = median, onlyvar = TRUE)

# Grouping data set
birds_temp_median <- cbind(birds_temp_median_01, birds_temp_median_04, birds_temp_median_07, birds_temp_median_11, birds_temp_median_15, birds_temp_median_17)

# Now, we need to summarise the climate variables per specie
temp_median_birds <- lets.summarizer2(birds_temp_median,  pos = 1049:1054, fun = median) 

colnames(temp_median_birds) <- c("Species", "Bio01_past", "Bio04_past", "Bio07_past",
                                 "Bio11_past", "Bio15_past", "Bio17_past")
glimpse(temp_median_birds)
```

##### 2.1.4. Mammals
```{r}
# Creating PresenceAusence object for lets.addvar
mammals_presaus <- lets.presab(mammals_shape , xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(mammals_presaus$Richness_Raster) <- projection(bio17_past_r)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
mammals_temp_median_01 <- lets.addvar(mammals_presaus, bio01_past_r, fun = median, onlyvar = FALSE)
mammals_temp_median_04 <- lets.addvar(mammals_presaus, bio04_past_r, fun = median, onlyvar = TRUE) 
mammals_temp_median_07 <- lets.addvar(mammals_presaus, bio07_past_r, fun = median, onlyvar = TRUE)
mammals_temp_median_11 <- lets.addvar(mammals_presaus, bio11_past_r, fun = median, onlyvar = TRUE)
mammals_temp_median_15 <- lets.addvar(mammals_presaus, bio15_past_r, fun = median, onlyvar = TRUE)
mammals_temp_median_17 <- lets.addvar(mammals_presaus, bio17_past_r, fun = median, onlyvar = TRUE)

# Grouping data set
mammals_temp_median <- cbind(mammals_temp_median_01, mammals_temp_median_04, mammals_temp_median_07, mammals_temp_median_11, mammals_temp_median_15, mammals_temp_median_17)

# Now, we need to summarise the climate variables per specie
temp_median_mammals <- lets.summarizer2(mammals_temp_median,  pos = 1258:1263, fun = median) 
colnames(temp_median_mammals) <- c("Species", "Bio01_past", "Bio04_past", "Bio07_past",
                                 "Bio11_past", "Bio15_past", "Bio17_past")
glimpse(temp_median_squamata)
```

#### 2.2. Present climate

##### 2.2.1. Frogs
```{r}
# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
projection(anura_presaus$Richness_Raster) <- projection(Bio01)
anura_temp_median_01_present <- lets.addvar(anura_presaus, Bio01, fun = median, onlyvar = FALSE)
anura_temp_median_04_present <- lets.addvar(anura_presaus, Bio04, fun = median, onlyvar = TRUE)
anura_temp_median_07_present <- lets.addvar(anura_presaus, Bio07, fun = median, onlyvar = TRUE)
anura_temp_median_11_present <- lets.addvar(anura_presaus, Bio11, fun = median, onlyvar = TRUE)
anura_temp_median_15_present <- lets.addvar(anura_presaus, Bio15, fun = median, onlyvar = TRUE)
anura_temp_median_17_present <- lets.addvar(anura_presaus, Bio17, fun = median, onlyvar = TRUE)

# Grouping data set
anura_temp_median_present <- cbind(anura_temp_median_01_present, anura_temp_median_04_present, anura_temp_median_07_present, anura_temp_median_11_present, anura_temp_median_15_present, anura_temp_median_17_present)
View(anura_temp_median_present)

# Now, we need to summarise the climate variables per specie
temp_median_anura_present <- lets.summarizer2(anura_temp_median_present,  pos = 2625:2630, fun = median) 

colnames(temp_median_anura_present) <- c("Species", "Bio01_present", "Bio04_present", "Bio07_present",
                                 "Bio11_present", "Bio15_present", "Bio17_present")
glimpse(temp_median_anura_present)
```

##### 2.2.2. Squamata
```{r}
# Creating PresenceAusence object for lets.addvar
#squamata_presaus <- lets.presab(squamata_shape , xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(squamata_presaus$Richness_Raster) <- projection(Bio17)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
squamata_temp_median_01_present <- lets.addvar(squamata_presaus, Bio01, fun = median, onlyvar = FALSE)
squamata_temp_median_04_present <- lets.addvar(squamata_presaus, Bio04, fun = median, onlyvar = TRUE) 
squamata_temp_median_07_present <- lets.addvar(squamata_presaus, Bio07, fun = median, onlyvar = TRUE)
squamata_temp_median_11_present <- lets.addvar(squamata_presaus, Bio11, fun = median, onlyvar = TRUE)
squamata_temp_median_15_present <- lets.addvar(squamata_presaus, Bio15, fun = median, onlyvar = TRUE)
squamata_temp_median_17_present <- lets.addvar(squamata_presaus, Bio17, fun = median, onlyvar = TRUE)

# Grouping data set
squamata_temp_median_present <- cbind(squamata_temp_median_01_present, squamata_temp_median_04_present, squamata_temp_median_07_present, squamata_temp_median_11_present, squamata_temp_median_15_present, squamata_temp_median_17_present)

# Now, we need to summarise the climate variables per specie
temp_median_squamata_present <- lets.summarizer2(squamata_temp_median_present,  pos = 1049:1054, fun = median) 
colnames(temp_median_squamata_present) <- c("Species", "Bio01_present", "Bio04_present", "Bio07_present",
                                 "Bio11_present", "Bio15_present", "Bio17_present")
glimpse(temp_median_squamata_present)
```


##### 2.2.3. Birds
```{r}
# Creating PresenceAusence object for lets.addvar
#birds_presaus <- lets.presab(birds_shape, xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(birds_presaus$Richness_Raster) <- projection(Bio01)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
birds_temp_median_01_present <- lets.addvar(birds_presaus, Bio01, fun = median, onlyvar = FALSE)
birds_temp_median_04_present <- lets.addvar(birds_presaus, Bio04, fun = median, onlyvar = TRUE) 
birds_temp_median_07_present <- lets.addvar(birds_presaus, Bio07, fun = median, onlyvar = TRUE)
birds_temp_median_11_present <- lets.addvar(birds_presaus, Bio11, fun = median, onlyvar = TRUE)
birds_temp_median_15_present <- lets.addvar(birds_presaus, Bio15, fun = median, onlyvar = TRUE)
birds_temp_median_17_present <- lets.addvar(birds_presaus, Bio17, fun = median, onlyvar = TRUE)

# Grouping data set
squamata_temp_median_present <- cbind(birds_temp_median_01_present, birds_temp_median_04_present, birds_temp_median_07_present, birds_temp_median_11_present, birds_temp_median_15_present, birds_temp_median_17_present)
#View(squamata_temp_median_present)
# Now, we need to summarise the climate variables per specie
temp_median_birds_present <- lets.summarizer2(birds_temp_median_present,  pos = 1049:1054, fun = median) 

colnames(temp_median_birds_present) <- c("Species", "Bio01_present", "Bio04_present", "Bio07_present",
                                 "Bio11_present", "Bio15_present", "Bio17_present")
glimpse(temp_median_birds_present)
```

##### 2.2.4. Mammals

```{r}
# Creating PresenceAusence object for lets.addvar
#mammals_presaus <- lets.presab(mammals_shape , xmn = -180, xmx = 180, ymn = -60, ymx = 90)
projection(mammals_presaus$Richness_Raster) <- projection(Bio01)

# lets.addvar(PresenceAbsence object, raster variables, onlyvar = If TRUE only the matrix object will be returned., fun = mean)
mammals_temp_median_01_present <- lets.addvar(mammals_presaus, Bio01, fun = median, onlyvar = FALSE)
mammals_temp_median_04_present <- lets.addvar(mammals_presaus, Bio04, fun = median, onlyvar = TRUE) 
mammals_temp_median_07_present <- lets.addvar(mammals_presaus, Bio07, fun = median, onlyvar = TRUE)
mammals_temp_median_11_present <- lets.addvar(mammals_presaus, Bio11, fun = median, onlyvar = TRUE)
mammals_temp_median_15_present <- lets.addvar(mammals_presaus, Bio15, fun = median, onlyvar = TRUE)
mammals_temp_median_17_present <- lets.addvar(mammals_presaus, Bio17, fun = median, onlyvar = TRUE)

# Grouping data set
mammals_temp_median_present <- cbind(mammals_temp_median_01_present, mammals_temp_median_04_present, mammals_temp_median_07_present, mammals_temp_median_11_present, mammals_temp_median_15_present, mammals_temp_median_17_present)
View(mammals_temp_median_present)
# Now, we need to summarise the climate variables per specie
temp_median_mammals_present <- lets.summarizer2(mammals_temp_median_present,  pos = 1258:1263, fun = median)
colnames(temp_median_mammals_present) <- c("Species", "Bio01_present", "Bio04_present", "Bio07_present",
                                 "Bio11_present", "Bio15_present", "Bio17_present")
glimpse(temp_median_mammals_present)
```


### 3.0 Save data

```{r}
# join past and present niche climate for tetrapods
climate_niche_amphibia <- inner_join(temp_median_anura, temp_median_anura_present, by="Species")
climate_niche_squamata <- inner_join(temp_median_squamata, temp_median_squamata_present, by="Species")
climate_niche_birds <- inner_join(temp_median_birds, temp_median_squamata_birds, by="Species")
climate_niche_mammals <- inner_join(temp_median_mammals, temp_median_mammals_present, by="Species")

# save dataset
write.table(climate_niche_amphibia, "climate_data/climate_niche_amphibia.txt", 
            sep=",", quote=FALSE, row.names = F)
write.table(climate_niche_squamata, "climate_data/climate_niche_squamata.txt", 
            sep=",", quote=FALSE, row.names = F)
write.table(climate_niche_birds, "climate_data/climate_niche_birds.txt", 
            sep=",", quote=FALSE, row.names = F)
write.table(climate_niche_mammals, "climate_data/climate_niche_mammals.txt", 
            sep=",", quote=FALSE, row.names = F)
```