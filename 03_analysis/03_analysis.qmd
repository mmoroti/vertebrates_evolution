---
title: "03_analysis"
author: "Matheus Moroti"
format: html
editor: visual
---

### 0.0. Libraries

```{r}
library(visdat) # missing data check
library(vegan) # normalize dataset
library(picante) # prune sample with phy
library(tidyverse) # data science handling
library(phytools) # phylogenetic data
library(nlme) # gls analysis
library(cowplot) # plots
```


### 0.2. Load data

#### 0.2.1. List of species

```{r}
amphibia_full_list <- read.table("list_of_species/composition_amphibia.txt", h=T) #Vanconcelos et al. (2019);
squamata_full_list <- read.table("list_of_species/composition_reptiles.txt", h=T) #Roll et al. (2017);
birds_full_list <- read.table("list_of_species/composition_birds.txt", h=T) #BirdLife (2015); 
mammals_full_list <- read.table("list_of_species/composition_mammals.txt", h=T) #IUCN  
```

#### 0.2.2. Climate niche

```{r}
# present climate OMI
amphibia_full_niche <- read.table("climate_niche/niche_omi_amphibia.txt", sep=",", h=T)[,2:3]
amphibia_full_niche$Species <- row.names(amphibia_full_niche)

squamata_full_niche <- read.table("climate_niche/niche_omi_squamata.txt", sep=",", h=T)[,2:3]
squamata_full_niche$Species <- row.names(squamata_full_niche)


birds_full_niche <- read.table("climate_niche/niche_omi_birds.txt", sep=",", h=T)[,2:3]
birds_full_niche$Species <- row.names(birds_full_niche)

mammals_full_niche <- read.table("climate_niche/niche_omi_mammals.txt", sep=",", h=T)[,2:3]
mammals_full_niche$Species <- row.names(mammals_full_niche)

#past climate OMI
amphibia_full_niche_past <- read.table("climate_niche/niche_omi_amphibia_past.txt", sep=",", h=T)[,2:3]
amphibia_full_niche_past$Species <- row.names(amphibia_full_niche_past)

squamata_full_niche_past <- read.table("climate_niche/niche_omi_squamata_past.txt",sep=",", h=T)[,2:3]
squamata_full_niche_past$Species <- row.names(squamata_full_niche_past)

birds_full_niche_past <- read.table("climate_niche/niche_omi_birds_past.txt", sep=",", h=T)[,2:3]
birds_full_niche_past$Species <- row.names(birds_full_niche_past)

mammals_full_niche_past <- read.table("climate_niche/niche_omi_mammals_past.txt", sep=",", h=T)[,2:3]
mammals_full_niche_past$Species <- row.names(mammals_full_niche_past)
```

#### 0.2.3. Rate trait evolution

```{r}
amphibia_full_rates <- read.table("trait_evolution/amphibia_rates_fully.txt", h=F) 
squamata_full_rates <- read.table("trait_evolution/squamata_rates_fully.txt", h=F) 
birds_full_rates <- read.table("trait_evolution/birds_rates_fully.txt", h=F) 
mammals_full_rates <- read.table("trait_evolution/mammals_rates_fully.txt", h=F) 
```

#### 0.2.4. Phylogeny
```{r}
anura_phy_full <- read.tree("phylogeny/amphibia_fully.tre")
squamata_phy_full <- read.tree("phylogeny/squamata_fully.tre")
birds_phy_full <- read.tree("phylogeny/birds_fully.tre")
mammals_phy_full <- read.tree("phylogeny/mammals_fully.tre")
```

### 1.0. Select pool species of Atlantic forest

#### 1.1. Amphibia
Merge with climate niche (Present data)
```{r}
# present data
# Transform column names to rows
amphibia_list <- amphibia_full_list %>% 
  gather(key = "Species", value = "column_value", Rhinella_azarai:Scinax_cretatus) %>%
  distinct(Species) %>%
  arrange(Species)

# adjustments in nomenclature
amphibia_list$Species <- str_replace_all(amphibia_list$Species, "Scinax_v-signatus", "Scinax_v.signatus") 
amphibia_list$Species <- str_replace_all(amphibia_list$Species, "Scinax_x-signatus", "Scinax_x.signatus")

# join with climate niche
species_climate_niche <- left_join(amphibia_list, amphibia_full_niche , by="Species")

# verifing the species don't merge
anti_join(amphibia_list, amphibia_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche)) # 0 NA's
# vis_miss(species_climate_niche) # 0.4 % missing data
#View(species_climate_niche)
```

Merge with climate niche (Past data)
```{r}
# past data
# join with climate niche
species_climate_niche_past <- left_join(amphibia_list, amphibia_full_niche_past , by="Species")

# verifing the species don't merge
# anti_join(amphibia_list, amphibia_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_past)) # 0 NA's
# vis_miss(species_climate_niche_past) # 0.4 % missing data
#View(species_climate_niche_past)
```

Merge with trait evolution rate
```{r}
# Merge with trait evolution rate
amphibia_full_rates <- amphibia_full_rates %>% rename(Species = V1, trait_rate = V2)
#View(amphibia_full_rates)

# adjustments in nomenclature
amphibia_full_rates$Species <- str_replace_all(amphibia_full_rates$Species, "Hylomantis_aspera", "Agalychnis_aspera") %>%
  str_replace_all("Hylomantis_granulosa", "Agalychnis_granulosa") %>%
  str_replace_all("Eupemphix_nattereri", "Physalaemus_nattereri") %>%
  str_replace_all("Rana_palmipes", "Lithobates_palmipes") %>%
  str_replace_all("Phyllomedusa_azurea", "Pithecopus_azureus") %>%
  str_replace_all("Phyllomedusa_ayeaye", "Pithecopus_ayeaye") %>%
  str_replace_all("Phyllomedusa_nordestina", "Pithecopus_nordestinus") %>%
  str_replace_all("Phyllomedusa_rohdei", "Pithecopus_rohdei") %>%
  str_replace_all("Phyllomedusa_megacephala", "Pithecopus_megacephalus") %>%
  str_replace_all("Phyllomedusa_hypochondrialis", "Pithecopus_hypochondrialis") %>%
  str_replace_all("Phyllomedusa_rohdei", "Pithecopus_rohdei") %>%
  str_replace_all("Scinax_tripui","Ololygon_tripui") %>% 
  str_replace_all("Scinax_cosenzai", "Ololygon_cosenzai") %>% 
  str_replace_all("Scinax_strigilatus", "Ololygon_strigilata") %>% 
  str_replace_all("Bokermannohyla_claresignata", "Boana_claresignata") %>%
  str_replace_all("Hypsiboas_bandeirantes", "Boana_bandeirantes") %>%
  str_replace_all("Hypsiboas_poaju","Boana_poaju")

# merge
# all species (with NA's)
# amphibia_dataset <- left_join(species_climate_niche, amphibia_full_rates, by="Species")

# only species with phylogeny
amphibia_dataset <- inner_join(species_climate_niche, amphibia_full_rates, by="Species")
amphibia_dataset_past <- inner_join(species_climate_niche_past, amphibia_full_rates, by="Species")

# sum(is.na(amphibia_dataset)) # 57 spp ausentes na filogenia
head(amphibia_dataset)
hist(amphibia_dataset$trait_rate)

# conferind NA's
#View(anti_join(amphibia_dataset, amphibia_full_rates, by="Species")) 
#View(anti_join(amphibia_list, amphibia_full_rates, by="Species")) 
```

Phylogeny to PGLS
```{r}
# species in colnames for prune.sample
amp_community_phy <- amphibia_dataset %>%
  spread(Species, as.numeric(trait_rate))

# adjustments in phy file
anura_phy_full$tip.label <- gsub("Hylomantis_aspera", "Agalychnis_aspera", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Hylomantis_granulosa", "Agalychnis_granulosa", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Phyllomedusa_rohdei", "Pithecopus_rohdei", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Phyllomedusa_nordestina", "Pithecopus_nordestinus", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Phyllomedusa_azurea", "Pithecopus_azureus", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Phyllomedusa_ayeaye", "Pithecopus_ayeaye", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Eupemphix_nattereri", "Physalaemus_nattereri", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Scinax_tripui", "Ololygon_tripui", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Scinax_strigilatus", "Ololygon_strigilata", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Rana_palmipes", "Lithobates_palmipes", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Phyllomedusa_megacephala", "Pithecopus_megacephalus", fixed=T, anura_phy_full$tip.label)
anura_phy_full$tip.label <- gsub("Phyllomedusa_hypochondrialis", "Pithecopus_hypochondrialis", fixed=T, anura_phy_full$tip.label)

anura_phy_pgls <- prune.sample(amp_community_phy, anura_phy_full)

```

#### 1.2. Squamata
Merge with climate niche (Present data)
```{r}
# present data
# Transform column names to rows
names(squamata_full_list) <- gsub(".", "_", fixed=T, names(squamata_full_list))
squamata_list <- squamata_full_list %>% 
  gather(key = "Species", value = "column_value", Acanthochelys_radiolata:Xenopholis_undulatus) %>%
  distinct(Species) %>%
  arrange(Species)

squamata_full_niche <- squamata_full_niche %>% mutate(Species = gsub("\\.", "_", Species))

# join with climate niche
species_climate_niche_squamata <- left_join(squamata_list, squamata_full_niche, by="Species")

# verifing the species don't merge
anti_join(amphibia_list, amphibia_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_squamata)) # 0 NA's
#vis_miss(species_climate_niche) # 0.0 % missing data
nrow(species_climate_niche_squamata)
```

Merge with climate niche (Past data)
```{r}
# past data
# join with climate niche
squamata_full_niche_past <- squamata_full_niche_past %>% mutate(Species = gsub("\\.", "_", Species))
species_climate_niche_past_squamata <- left_join(squamata_list, squamata_full_niche_past , by="Species")

# verifing the species don't merge
# anti_join(amphibia_list, amphibia_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_past_squamata)) # 0 NA's
# vis_miss(species_climate_niche_past) # 0.4 % missing data
#View(species_climate_niche_past)
```

Merge with trait evolution rate
```{r}
# Merge with trait evolution rate
squamata_full_rates <- squamata_full_rates %>% rename(Species = V1, trait_rate = V2)
#View(amphibia_full_rates)

# adjustments in nomenclature
#amphibia_full_rates$Species <- str_replace_all(amphibia_full_rates$Species, "Hylomantis_aspera", "Agalychnis_aspera") 

# merge
# all species (with NA's)
# amphibia_dataset <- left_join(species_climate_niche, amphibia_full_rates, by="Species")

# only species with phylogeny
squamata_dataset <- inner_join(species_climate_niche_squamata, squamata_full_rates, by="Species")
squamata_dataset_past <- inner_join(species_climate_niche_past_squamata, squamata_full_rates, by="Species")

anti_join(species_climate_niche_past_squamata, squamata_full_rates, by="Species")
# sairam poucas espécies, maioria crocodilo e tartaruga
# sum(is.na(amphibia_dataset)) # 57 spp ausentes na filogenia
head(squamata_dataset)
hist(squamata_dataset$trait_rate)

# conferind NA's
#View(anti_join(amphibia_dataset, amphibia_full_rates, by="Species")) 
#View(anti_join(amphibia_list, amphibia_full_rates, by="Species")) 
```

Phylogeny to PGLS
```{r}
# species in colnames for prune.sample
squamata_community_phy <- squamata_dataset %>%
  spread(Species, as.numeric(trait_rate))

# adjustments in phy file
#anura_phy_full$tip.label <- gsub("Hylomantis_aspera", "Agalychnis_aspera", fixed=T, anura_phy_full$tip.label)

squamata_phy_pgls <- prune.sample(squamata_community_phy, squamata_phy_full) # 368
nrow(squamata_dataset) # 368 
```


#### 1.3. Birds
Merge with climate niche (Present data)
```{r}
# present data
# Transform column names to rows
names(birds_full_list) <- gsub(".", "_", fixed=T, names(birds_full_list))

View(birds_full_list)

birds_list <- birds_full_list %>% 
  gather(key = "Species", value = "column_value", Amazona_aestiva:Sporophila_hypoxantha) %>%
  distinct(Species) %>%
  arrange(Species)

birds_full_niche <- birds_full_niche %>% mutate(Species = gsub("\\.", "_", Species))

# join with climate niche
species_climate_niche_birds <- left_join(birds_list, birds_full_niche, by="Species")

# verifing the species don't merge
anti_join(birds_list, birds_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_birds)) # 0 NA's
#vis_miss(species_climate_niche) # 0.0 % missing data
nrow(species_climate_niche_birds)
```

Merge with climate niche (Past data)
```{r}
# past data
# join with climate niche
birds_full_niche_past <- birds_full_niche_past %>% mutate(Species = gsub("\\.", "_", Species))
species_climate_niche_past_birds <- left_join(birds_list, birds_full_niche_past , by="Species")

# verifing the species don't merge
# anti_join(amphibia_list, amphibia_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_past_birds)) # 0 NA's
# vis_miss(species_climate_niche_past) # 0.4 % missing data
#View(species_climate_niche_past)
```

Merge with trait evolution rate
```{r}
# Merge with trait evolution rate
birds_full_rates <- birds_full_rates %>% rename(Species = V1, trait_rate = V2)
#View(amphibia_full_rates)

# adjustments in nomenclature
#amphibia_full_rates$Species <- str_replace_all(amphibia_full_rates$Species, "Hylomantis_aspera", "Agalychnis_aspera") 

# merge
# all species (with NA's)
# amphibia_dataset <- left_join(species_climate_niche, amphibia_full_rates, by="Species")

# only species with phylogeny
birds_dataset <- inner_join(species_climate_niche_birds, birds_full_rates, by="Species")
birds_dataset_past <- inner_join(species_climate_niche_past_birds, birds_full_rates, by="Species")

anti_join(species_climate_niche_past_birds, birds_full_rates, by="Species")

# sairam poucas espécies, maioria crocodilo e tartaruga
# sum(is.na(amphibia_dataset)) # 57 spp ausentes na filogenia
# head(squamata_dataset)
# hist(squamata_dataset$trait_rate)

# conferind NA's
#View(anti_join(amphibia_dataset, amphibia_full_rates, by="Species")) 
#View(anti_join(amphibia_list, amphibia_full_rates, by="Species")) 
```

Phylogeny to PGLS
```{r}
# species in colnames for prune.sample
birds_community_phy <- birds_dataset %>%
  spread(Species, as.numeric(trait_rate))

# adjustments in phy file
#anura_phy_full$tip.label <- gsub("Hylomantis_aspera", "Agalychnis_aspera", fixed=T, anura_phy_full$tip.label)

birds_phy_pgls <- prune.sample(birds_community_phy, birds_phy_full) # 695
nrow(birds_dataset) # 695 
```

#### 1.4. Mammals
Merge with climate niche (Present data)
```{r}
# present data
# Transform column names to rows
names(mammals_full_list) <- gsub(".", "_", fixed=T, names(mammals_full_list))

View(mammals_full_list)

mammals_list <- mammals_full_list %>% 
  gather(key = "Species", value = "column_value", Euryoryzomys_lamia:Callithrix_aurita) %>%
  distinct(Species) %>%
  arrange(Species)

mammals_full_niche <- mammals_full_niche %>% mutate(Species = gsub("\\.", "_", Species))

# join with climate niche
species_climate_niche_mammals <- left_join(mammals_list, mammals_full_niche, by="Species")

# verifing the species don't merge
anti_join(mammals_list, mammals_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_mammals)) # 0 NA's
#vis_miss(species_climate_niche) # 0.0 % missing data
nrow(species_climate_niche_mammals)
```

Merge with climate niche (Past data)
```{r}
# past data
# join with climate niche
mammals_full_niche_past <- mammals_full_niche_past %>% mutate(Species = gsub("\\.", "_", Species))
species_climate_niche_past_mammals <- left_join(mammals_list, mammals_full_niche_past , by="Species")

# verifing the species don't merge
# anti_join(amphibia_list, amphibia_full_niche, by="Species") # 0 rows

sum(is.na(species_climate_niche_past_mammals)) # 0 NA's
# vis_miss(species_climate_niche_past) # 0.4 % missing data
#View(species_climate_niche_past)
```

Merge with trait evolution rate
```{r}
# Merge with trait evolution rate
mammals_full_rates <- mammals_full_rates %>% rename(Species = V1, trait_rate = V2)
#View(amphibia_full_rates)

# adjustments in nomenclature
#amphibia_full_rates$Species <- str_replace_all(amphibia_full_rates$Species, "Hylomantis_aspera", "Agalychnis_aspera") 

# merge
# all species (with NA's)
# amphibia_dataset <- left_join(species_climate_niche, amphibia_full_rates, by="Species")

# only species with phylogeny
mammals_dataset <- inner_join(species_climate_niche_mammals, mammals_full_rates, by="Species")
mammals_dataset_past <- inner_join(species_climate_niche_past_mammals, mammals_full_rates, by="Species")

anti_join(species_climate_niche_past_mammals, mammals_full_rates, by="Species")

# sairam poucas espécies, maioria crocodilo e tartaruga
# sum(is.na(amphibia_dataset)) # 57 spp ausentes na filogenia
# head(squamata_dataset)
# hist(squamata_dataset$trait_rate)

# conferind NA's
#View(anti_join(amphibia_dataset, amphibia_full_rates, by="Species")) 
#View(anti_join(amphibia_list, amphibia_full_rates, by="Species")) 
```

Phylogeny to PGLS
```{r}
# species in colnames for prune.sample
mammals_community_phy <- mammals_dataset %>%
  spread(Species, as.numeric(trait_rate))

# adjustments in phy file
#anura_phy_full$tip.label <- gsub("Hylomantis_aspera", "Agalychnis_aspera", fixed=T, anura_phy_full$tip.label)

mammals_phy_pgls <- prune.sample(mammals_community_phy, mammals_phy_full) # 194
nrow(mammals_dataset) # 194 
```


### 2.0. PGLS
#### 2.1. Amphibia
```{r}
# Past data
#amphibia_dataset_trans_past <- decostand(amphibia_dataset_past[,2:4], "normalize")
#amphibia_dataset_trans_past <- cbind(Species = amphibia_dataset_past[,1],amphibia_dataset_trans_past)
#amphibia_dataset_trans_past

model_anura_svl_past <- gls(trait_rate ~ OMI + Tol, data=amphibia_dataset_past, 
                       correlation = corPagel(1,anura_phy_pgls, form = ~Species))

summary(model_anura_svl_past)

anura_past <- plot(model_anura_svl_past, main= "Past climate data")

# Present data 
amphibia_dataset_trans <- decostand(amphibia_dataset[,2:4], "normalize")
amphibia_dataset_trans <- cbind(Species = amphibia_dataset[,1],amphibia_dataset_trans)
#amphibia_dataset_trans

model_anura_svl <- gls(trait_rate ~ OMI + Tol, data=amphibia_dataset, 
                       correlation = corPagel(1,anura_phy_pgls, form = ~Species))
summary(model_anura_svl)

anura_present <- plot(model_anura_svl, main= "Present climate data")

plot_grid(anura_past, anura_present, align = "h", labels = NULL)
```

#### 2.2. Squamata
```{r}
# Past data
squamata_dataset_trans_past <- decostand(squamata_dataset_past[,2:4], "normalize")
squamata_dataset_trans_past <- cbind(Species = squamata_dataset_past[,1],squamata_dataset_trans_past)
squamata_dataset_trans_past

model_squamata_svl_past <- gls(trait_rate ~ OMI + Tol, data=squamata_dataset_trans_past, 
                       correlation = corPagel(1,squamata_phy_pgls, form = ~Species))

summary(model_squamata_svl_past)

squamata_past <- plot(model_squamata_svl_past, main= "Past climate data")

# Present data 
squamata_dataset_trans <- decostand(squamata_dataset[,2:4], "normalize")
squamata_dataset_trans <- cbind(Species = squamata_dataset[,1],squamata_dataset_trans)
squamata_dataset_trans

model_squamata_svl <- gls(trait_rate ~ OMI + Tol, data=squamata_dataset_trans, 
                       correlation = corPagel(1,squamata_phy_pgls, form = ~Species))
summary(model_squamata_svl)

squamata_present <- plot(model_squamata_svl, main= "Present climate data")

plot_grid(squamata_past, squamata_present, align = "h", labels = NULL)
```

#### 2.3. Birds
```{r}
# Past data
birds_dataset_trans_past <- decostand(birds_dataset_past[,2:4], "normalize")
birds_dataset_trans_past <- cbind(Species = birds_dataset_past[,1],birds_dataset_trans_past)
birds_dataset_trans_past

model_birds_svl_past <- gls(trait_rate ~ OMI + Tol, data=birds_dataset_trans_past, 
                       correlation = corPagel(1,birds_phy_pgls, form = ~Species))

summary(model_birds_svl_past)
R2(model_squamata_svl_past)

# plot
birds_past <- plot(model_birds_svl_past, main= "Past climate data")

# Present data 
birds_dataset_trans <- decostand(birds_dataset[,2:4], "normalize")
birds_dataset_trans <- cbind(Species = birds_dataset[,1], birds_dataset_trans)
birds_dataset_trans

model_birds_svl <- gls(trait_rate ~ OMI + Tol, data=birds_dataset, 
                       correlation = corPagel(1,birds_phy_pgls, form = ~Species))
summary(model_birds_svl)
R2(model_birds_svl)

# plot
birds_present <- plot(model_birds_svl, main= "Present climate data")

plot_grid(birds_past, birds_present, align = "h", labels = NULL)
```

#### 2.4. Mammals
```{r}
# Past data
mammals_dataset_trans_past <- decostand(mammals_dataset_past[,2:4], "normalize")
mammals_dataset_trans_past <- cbind(Species = mammals_dataset_past[,1],mammals_dataset_trans_past)
mammals_dataset_trans_past

model_mammals_svl_past <- gls(trait_rate ~ OMI + Tol, data=mammals_dataset_trans_past, 
                       correlation = corPagel(1,mammals_phy_pgls, form = ~Species))

summary(model_mammals_svl_past)
R2(model_mammals_svl_past)

# plot
mammals_past <- plot(model_mammals_svl_past, main= "Past climate data")

# Present data 
mammals_dataset_trans <- decostand(mammals_dataset[,2:4], "normalize")
mammals_dataset_trans <- cbind(Species = mammals_dataset[,1], mammals_dataset_trans)
mammals_dataset_trans

model_mammals_svl <- gls(trait_rate ~ OMI + Tol, data=mammals_dataset_trans, 
                       correlation = corPagel(1,mammals_phy_pgls, form = ~Species))
summary(model_mammals_svl)
R2(model_mammals_svl)

# plot
mammals_present <- plot(model_mammals_svl, main= "Present climate data")

plot_grid(mammals_past, mammals_present, align = "h", labels = NULL)
```


### 3.0. Plots
```{r}

```
